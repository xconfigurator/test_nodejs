<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: 02_saveWarns.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: 02_saveWarns.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * 从设备信息devices集合中分离出告警信息
 * 保存进入warns集合
 * 参考chenchen saveDevicePerform(deviceId) in db.js
 * 主要实现抽离和入库逻辑
 * 相关代码计划合并至工程的db.js中
 */
var MongoClient = require('mongodb').MongoClient
var conf = require('./db.conf.js')
const isDebug = true // 是否输出调试信息

function _connectDB (callback) {
  MongoClient.connect(conf.url, function (err, db) {
    if (err) throw err
    if (isDebug) console.log('连接成功')
    callback(db)
  })
}

function findAll (collectionName, json, callback) {
  // TODO 需要参数判断
  if (arguments.length !== 3) {
    // callback('', null) // 这个咋写
  }

  if (isDebug) {
    console.log('#debug collectionName = ' + collectionName)
    console.log('#debug json = ' + JSON.stringify(json))
    console.log('#debug callback = ' + callback)
  }

  _connectDB(function (db) {
    var result = []
    var cursor = db.collection(collectionName).find(json)
    cursor.each(function (err, doc) {
      if (err) {
        callback(err, null)
      }
      if (doc !== null) {
        // console.dir(doc)
        result.push(doc)
      } else {
        // 遍历结束
        callback(null, result)
      }
    }) // end of cursor

    db.close()
  })
}

function insertOne (collectionName, json, callback) {
  _connectDB(function (db) {
    db.collection(collectionName).insertOne(json, function (err, result) {
      callback(err, result)
      db.close()
    })
  })
}

// 检索设备信息
// var deviceInfo = {}
// findAll('devices', { '_id': 'FFFFFF-Generic-FFFFFF123461' }, function (err, result) {
findAll('devices', {}, function (err, result) {
  if (err) throw err
  // var warnsInfo = extractWarnsInfo(result[0]) // 抽取
  // var warnsInfo = {}
  for (var idx in result) {
    var warnsInfo = extractWarnsInfo(result[idx])
    console.log('warnsInfo = ' + JSON.stringify(warnsInfo))
    if (warnsInfo !== null) {
      persistWarnsInfo(warnsInfo) // 持久化   
    }
  }
})

////////////////////////////////////////////////////////////////////////////////////////////

/**
 * 分离出告警信息(后续可能需要根据不同设备上传信息不同适配不同的解析器)
 * @param {string} deviceInfo 设备信息JSON对象
 * @returns {Object} 返回设备告警信息JSON对象，如果设备信息中不存在告警信息则返回null
 * @author liuyang
 * @since 2018/6/21
 */
function extractWarnsInfo (deviceInfo) {
  // 1. 设备信息中有可能不包含告警信息
  if (deviceInfo.InternetGatewayDevice.warn == null) return null
  if (deviceInfo.InternetGatewayDevice.warn.warn == null) return null

  // 2. 告警信息。格式以南向接口文档为准。
  // 注：如果包含告警信息，有可能不止一条
  var warn = {}
  var warnData = {}
  var warnObj = deviceInfo.InternetGatewayDevice.warn.warn
  // 解析（后续可能根据设备类型不同适配多个解析器）
  for (var key in warnObj) {
    if (key === '_object') continue // 跳过_object属性
    var warnItem = {
      'Id': key,
      'Action': '0', // 发生告警\消除告警 0/1
      'Level': warnObj[key].level._value,
      'Description': warnObj[key].msg._value,
      'Time': warnObj[key].time._value
    }
    warnData[key] = warnItem
  }

  warn.deviceId = deviceInfo._id
  warn.timestamp = new Date()
  warn.warnData = warnData

  // 3. 待确认：不同设备的告警信息格式是否相同 (当前得知，TAU和CPE的格式不，后续可能需要定制)
  return warn
}

/**
 *  告警信息入库 warns
 *   
 */
function persistWarnsInfo (warnsInfo) {
  insertOne('warns', warnsInfo, function (err, result) {
    if (err) throw err
    if (isDebug) console.log(JSON.stringify(result))
  })
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#extractWarnsInfo">extractWarnsInfo</a></li><li><a href="global.html#MongoClient">MongoClient</a></li><li><a href="global.html#persistWarnsInfo">persistWarnsInfo</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jun 22 2018 10:02:16 GMT+0800 (中国标准时间)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
